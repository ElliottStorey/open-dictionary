<head>
    <title>Open Dictionary</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    </link>
</head>

<style>
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
        display: flex;
        flex: 1;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
    }

    #content {
        flex: 1;
        display: flex;
        overflow: auto;
        width: 100%;
        max-width: 30rem;
    }

    #box {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: min-content;
        width: 100%;
    }

    /* --- Loading & Error Styles --- */
    #loading {
        text-align: center;
        color: gray;
        margin-top: 3rem;
        font-style: italic;
        animation: pulse 1.5s infinite ease-in-out;
    }

    .error-msg {
        text-align: center;
        color: #d9534f; /* Reddish color for errors */
        margin-top: 3rem;
        font-weight: 500;
    }

    @keyframes pulse {
        0% { opacity: 0.4; }
        50% { opacity: 1; }
        100% { opacity: 0.4; }
    }
    /* ----------------------------- */

    .sense {
        padding: 0 1rem;
        border: 1px solid lightgray;
        border-radius: .25rem;
        margin: 0 1rem;
    }

    .sense h2 {
        margin-bottom: 0;
    }

    .sense p:nth-child(2) {
        margin: 0;
        color: gray;
    }

    .sense:nth form {
        margin: 1rem;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    form {
        width: 100%;
        display: flex;
        justify-content: center;
        margin: 1rem;
    }

    input {
        width: 100%;
        max-width: 30rem;
        font-size: medium;
        border: 1.5px solid lightgray;
        border-radius: .25rem;
        padding: 1rem;
        margin: 0 1rem;
    }
</style>

<h1 id="query"></h1>
<div id="content">
    <div id="box">
        <p id="loading">Searching dictionary...</p>
    </div>
</div>
<form onsubmit="submitQuery()">
    <input name="query" placeholder="Search for another word or phrase...">
</form>

<script>
    async function submitQuery() {
        event.preventDefault();
        const formData = new FormData(event.target);
        const query = formData.get("query");
        const url = new URL(`/search/${query}`, window.location.origin);
        window.location.assign(url);
    }
</script>
<script type="module">
    let { url, params: { query } } = $request;
    const boxElement = document.getElementById("box");

    document.title += ` | ${decodeURIComponent(query)}`;
    document.getElementById("query").textContent = decodeURIComponent(query);

    try {
        const response = await fetch(`../api/search/${query}`);
        
        // Handle HTTP errors (e.g. 404, 500)
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const reader = await response.body.pipeThrough(new TextDecoderStream()).getReader();
        let data = "";
        let hasResults = false;

        while (true) {
            const { value: part, done } = await reader.read();
            if (done) break;

            data += part;

            try {
                let senses;
                // Attempt to parse complete or partial JSON
                try {
                    senses = JSON.parse(data);
                } catch {
                    senses = JSON.parse(`${data}"}]`);
                }

                // If we have valid data, clear the loading text and render
                if (senses && senses.length > 0) {
                    hasResults = true; 
                    boxElement.innerHTML = ""; // Clear loading/previous content
                    
                    senses.forEach(sense => {
                        const senseDiv = document.createElement("div");
                        senseDiv.classList.add("sense");
                        
                        const spelling = document.createElement("h2");
                        spelling.textContent = sense.spelling;
                        senseDiv.appendChild(spelling);

                        const info = document.createElement("p");
                        info.textContent = sense.partOfSpeech;
                        if (sense?.pronunciations) {
                            info.textContent += ` â€¢ ${sense.pronunciations[0]}`;
                        }
                        senseDiv.appendChild(info);

                        const meaning = document.createElement("p");
                        meaning.textContent = sense.definition;
                        senseDiv.appendChild(meaning);

                        if (sense.sentence) {
                            const exampleLabel = document.createElement("p");
                            exampleLabel.innerHTML = "<b>Example</b>";
                            senseDiv.appendChild(exampleLabel);

                            const example = document.createElement("p");
                            example.textContent = sense.sentence;
                            senseDiv.appendChild(example);
                        }

                        boxElement.appendChild(senseDiv);
                    });
                }
            } catch { 
                // JSON parse errors are ignored here as we wait for more data chunks
            }
        }

        // Stream finished. If no results were ever rendered, show "Not Found"
        if (!hasResults) {
            boxElement.innerHTML = `<p class="error-msg">No definition found for "${decodeURIComponent(query)}". Gemini API key is likely missing.</p>`;
        }

    } catch (error) {
        // Handle Network or Fetch errors
        console.error(error);
        boxElement.innerHTML = `<p class="error-msg">Unable to retrieve definition. Please try again.</p>`;
    }
</script>
